# 📊 دليل حالات الطلب (Order Status Guide)

## 🔢 جدول حالات الطلب

| Status Code | الاسم | الوصف | الإشعار للمشتري | المسؤول |
|------------|-------|-------|-----------------|---------|
| **0** | Pending | في الانتظار | - | - |
| **1** | Confirmed/Accepted | تم قبول الطلب من المطعم | "تم تأكيد طلبك! ✅" | المطعم |
| **2** | Assigned to Delivery | تم تعيين مندوب | "تم تعيين مندوب للطلب 🚗" | المطعم |
| **3** | Accepted by Driver | المندوب قبل الطلب | "المندوب قبل طلبك 🚗" | المندوب |
| **5** | Rejected | ❌ **مرفوض** | "تم رفض طلبك ❌" | المطعم |
| **6** | Preparing | 👨‍🍳 **قيد التحضير** | "المطعم يحضر طلبك الآن 👨‍🍳" | المطعم |
| **7** | On The Way | في الطريق | "طلبك في الطريق إليك 🚚" | المندوب |
| **8** | Delivered | تم التوصيل | "تم تسليم طلبك 🎉" | المندوب |
| **9** | Cancelled | ملغي | "تم إلغاء طلبك ❌" | المطعم/المشتري |

---

## 🔄 سير العمل الصحيح

### مسار الطلب الناجح:
```
0 (Pending) 
  ↓
1 (Confirmed) ← المطعم يقبل
  ↓
2 (Assigned) ← المطعم يعين مندوب
  ↓
3 (Accepted by Driver) ← المندوب يقبل
  ↓
6 (Preparing) ← المطعم يبدأ التحضير
  ↓
7 (On The Way) ← المندوب ينطلق
  ↓
8 (Delivered) ← تم التوصيل
```

### مسار الرفض:
```
0 (Pending) 
  ↓
5 (Rejected) ← المطعم يرفض مباشرة
```

```
0 (Pending) 
  ↓
1 (Confirmed)
  ↓
2 (Assigned)
  ↓
4 (Rejected by Driver) ← المندوب يرفض
  ↓
2 (Re-assigned) ← تعيين مندوب آخر
```

---

## ⚠️ الأخطاء الشائعة - **تم إصلاحها**

### ❌ **خطأ سابق:**
```dart
// في orders-screen.dart - السطر 272
status: 5, // preparing  ❌ خطأ!
```
**المشكلة:** status 5 = Rejected وليس Preparing!  
**النتيجة:** المشتري يستلم رسالة "تم رفض طلبك" بدلاً من "يتم تحضير طلبك"

### ✅ **التصحيح:**
```dart
// في orders-screen.dart - السطر 272
status: 6, // preparing ✅ صحيح!
```

---

## 🎯 التعديلات التي تمت

### 1. في `orders-screen.dart`:
```dart
// وظيفة startPreparing
status: 6, // preparing (كان 5 خطأ)

// وظيفة markReady  
status: 7, // on the way (كان 6)
```

### 2. في `admin.js`:
```javascript
const msgMap = {
    1: 'تم تأكيد طلبك ✅',
    2: 'تم تعيين مندوب للطلب 🚗',
    3: 'المندوب قبل طلبك 🚗',
    5: 'تم رفض طلبك ❌',
    6: 'المطعم يحضر طلبك الآن 👨‍🍳', // محدّث
    7: 'طلبك في الطريق إليك 🚚',
    8: 'تم تسليم طلبك 🎉',
    9: 'تم إلغاء طلبك ❌',
};
```

### 3. في `fcm.js` و `fcm_admin.js`:
- تم تحديث رسائل الحالات لتطابق الأرقام الصحيحة
- إضافة Status 6 = "المطعم يحضر طلبك الآن 👨‍🍳"

---

## 📱 الإشعارات بين المطعم والمندوب

### عند تعيين المندوب:
- 🚗 **للمندوب:** "طلب توصيل جديد! 🚗"
- 🍕 **للمطعم:** "تم تعيين المندوب 🚗"

### عند قبول المندوب:
- 🍕 **للمطعم:** "المندوب قبل الطلب! ✅"

### عند رفض المندوب:
- 🍕 **للمطعم:** "المندوب رفض الطلب ❌ - السبب"

---

## 🧪 كيفية الاختبار

### اختبار "بدء التحضير":
1. افتح واجهة المطعم
2. اختر طلب مقبول (Status = 1 أو 2 أو 3)
3. اضغط "بدء إعداد الطعام"
4. ✅ **النتيجة المتوقعة:** المشتري يستلم "المطعم يحضر طلبك الآن 👨‍🍳"
5. ❌ **النتيجة السابقة (خطأ):** المشتري يستلم "تم رفض طلبك ❌"

### اختبار "جاهز للتوصيل":
1. اضغط "جاهز للتوصيل" (Mark Ready)
2. ✅ **النتيجة:** Status = 7 (On The Way)
3. المشتري يستلم "طلبك في الطريق إليك 🚚"

---

## 📝 ملاحظات مهمة

1. ✅ **Status 5 = Rejected** (مرفوض من المطعم)
2. ✅ **Status 6 = Preparing** (قيد التحضير)
3. ✅ **Status 7 = On The Way** (في الطريق)
4. ❌ **لا تستخدم Status 4** (محجوز لرفض المندوب داخلياً)
5. ✅ جميع الإشعارات تُرسل للمشتري عند تحديث الحالة
6. ✅ الإشعارات بين المطعم والمندوب تعمل بشكل منفصل

---

## ✅ الميزات المكتملة

- [x] إصلاح خطأ Status 5 vs 6
- [x] تحديث رسائل الحالات في جميع الملفات
- [x] إشعارات صحيحة للمشتري
- [x] إشعارات بين المطعم والمندوب
- [x] توثيق كامل لجميع الحالات

---

## 🔧 الملفات المعدلة

1. ✅ `lib/features/admin/screens/orders-screen.dart` - تصحيح الأرقام
2. ✅ `server/routes/admin.js` - تحديث الرسائل
3. ✅ `server/routes/fcm.js` - تحديث رسائل FCM
4. ✅ `server/routes/fcm_admin.js` - تحديث رسائل FCM
5. ✅ `server/routes/delivery.js` - إضافة الإشعارات للمطعم

---

**الآن النظام يعمل بشكل صحيح! 🎉**

