# 🔔 نظام الإشعارات بين المطعم والديليفري

## 📋 التغييرات التي تمت

### 1. الإشعارات الجديدة المضافة

#### أ) عند تعيين المندوب (Driver Assignment)
**من:** صاحب المطعم  
**إلى:** المندوب

- ✅ يصل إشعار للمندوب: "طلب توصيل جديد! 🚗"
- ✅ يصل إشعار للمطعم: "تم تعيين المندوب 🚗"

#### ب) عند قبول المندوب (Driver Acceptance)
**من:** المندوب  
**إلى:** صاحب المطعم

- ✅ يصل إشعار للمطعم: "المندوب قبل الطلب! ✅"
- يحتوي على اسم المندوب

#### ج) عند رفض المندوب (Driver Rejection)
**من:** المندوب  
**إلى:** صاحب المطعم

- ✅ يصل إشعار للمطعم: "المندوب رفض الطلب ❌"
- يحتوي على اسم المندوب وسبب الرفض (إذا وُجد)

---

## 📂 الملفات المعدلة

### 1. `/server/routes/fcm_admin.js`
**الوظائف المضافة:**
- `sendDriverAssignedNotificationToRestaurant()` - إشعار للمطعم عند تعيين المندوب
- `sendDeliveryAcceptedNotificationToRestaurant()` - إشعار للمطعم عند قبول المندوب
- `sendDeliveryRejectedNotificationToRestaurant()` - إشعار للمطعم عند رفض المندوب

### 2. `/server/routes/delivery.js`
**التعديلات:**
- عند **قبول الطلب** (Line 115-121): إرسال إشعار للمطعم
- عند **رفض الطلب** (Line 162-169): إرسال إشعار للمطعم

### 3. `/server/routes/admin.js`
**التعديلات:**
- عند **التعيين اليدوي** (Line 777-789): إرسال إشعار للمطعم + المندوب
- عند **التعيين التلقائي** (Line 612-624): إرسال إشعار للمطعم + المندوب

---

## 🔄 سير العمل الكامل

### السيناريو 1: تعيين المندوب
```
1. صاحب المطعم يضغط "تعيين الأقرب" أو يختار مندوب محدد
2. ✅ النظام يرسل إشعار للمندوب
3. ✅ النظام يرسل إشعار لصاحب المطعم
```

### السيناريو 2: المندوب يقبل الطلب
```
1. المندوب يضغط "قبول الطلب"
2. ✅ النظام يرسل إشعار لصاحب المطعم
3. صاحب المطعم يعلم أن المندوب قبل الطلب
```

### السيناريو 3: المندوب يرفض الطلب
```
1. المندوب يضغط "رفض الطلب" + يدخل السبب
2. ✅ النظام يرسل إشعار لصاحب المطعم
3. النظام يبحث عن مندوب آخر تلقائياً
4. ✅ يرسل إشعار للمندوب الجديد
```

---

## 🧪 كيفية الاختبار

### 1. تعيين المندوب
```bash
# من واجهة صاحب المطعم
1. افتح قائمة الطلبات
2. اختر طلب مقبول (Status = 1)
3. اضغط "تعيين سائق"
4. اختر مندوب أو اضغط "تعيين الأقرب"

# النتيجة المتوقعة:
- يصل إشعار للمندوب ✅
- يصل إشعار لصاحب المطعم ✅
```

### 2. قبول المندوب
```bash
# من واجهة المندوب
1. افتح الطلبات المعينة لك
2. اضغط "قبول الطلب"

# النتيجة المتوقعة:
- يصل إشعار لصاحب المطعم ✅
```

### 3. رفض المندوب
```bash
# من واجهة المندوب
1. افتح الطلبات المعينة لك
2. اضغط "رفض الطلب"
3. اكتب سبب الرفض

# النتيجة المتوقعة:
- يصل إشعار لصاحب المطعم مع السبب ✅
```

---

## 📊 أنواع الإشعارات

| الحدث | المرسل | المستقبل | الرسالة | نوع البيانات |
|------|--------|---------|---------|--------------|
| تعيين المندوب | النظام | المندوب | طلب توصيل جديد! 🚗 | `delivery_assigned` |
| تعيين المندوب | النظام | المطعم | تم تعيين المندوب 🚗 | `driver_assigned` |
| قبول المندوب | المندوب | المطعم | المندوب قبل الطلب! ✅ | `delivery_accepted` |
| رفض المندوب | المندوب | المطعم | المندوب رفض الطلب ❌ | `delivery_rejected` |

---

## 🔑 بيانات الإشعار (Notification Data)

### عند التعيين
```json
{
  "type": "driver_assigned",
  "orderId": "ORDER_ID",
  "deliveryId": "DELIVERY_ID",
  "deliveryName": "اسم المندوب"
}
```

### عند القبول
```json
{
  "type": "delivery_accepted",
  "orderId": "ORDER_ID",
  "deliveryId": "DELIVERY_ID",
  "deliveryName": "اسم المندوب"
}
```

### عند الرفض
```json
{
  "type": "delivery_rejected",
  "orderId": "ORDER_ID",
  "deliveryId": "DELIVERY_ID",
  "deliveryName": "اسم المندوب",
  "reason": "سبب الرفض"
}
```

---

## 🛠️ متطلبات التشغيل

1. ✅ Firebase Admin SDK مفعّل
2. ✅ FCM Tokens محفوظة لكل مستخدم
3. ✅ Channel ID = `food_delivery_channel`
4. ✅ Priority = `high` للإشعارات الفورية

---

## 📝 ملاحظات

- جميع الإشعارات تُرسل بـ Priority عالية لضمان الوصول الفوري
- إذا فشل إرسال الإشعار، لا تفشل العملية (try-catch)
- يتم حفظ سبب الرفض في قاعدة البيانات
- النظام يبحث عن مندوب آخر تلقائياً عند الرفض

---

## ✅ الميزات المكتملة

- [x] إشعار للمندوب عند التعيين
- [x] إشعار للمطعم عند التعيين
- [x] إشعار للمطعم عند قبول المندوب
- [x] إشعار للمطعم عند رفض المندوب
- [x] حفظ سبب الرفض
- [x] إعادة التعيين التلقائي عند الرفض

